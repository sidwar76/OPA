name: work
on:
  push:
    branches:
      - master

jobs:
  push_to_registry:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v2
        
      - name: Install cosign
        run: |
          curl -L https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 -o /tmp/cosign
          chmod +x /tmp/cosign
          sudo mv /tmp/cosign /usr/local/bin/cosign

      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: docker build -t sidwar/myapp:latest .

      - name: Sign and push docker image
        uses: sudo-bot/action-docker-sign@latest
        with:
          image-ref: "sidwar/myapp:latest"
          private-key-id: "${{ secrets.DOCKER_PRIVATE_KEY_ID }}"
          private-key: ${{ secrets.DOCKER_PRIVATE_KEY }}
          private-key-passphrase: ${{ secrets.COMMON_PASSPHRASE }}
          
      - name: Save public key to a file
        run: echo "$DOCKER_PUBLIC_KEY" > public_key.pem
        env:
          DOCKER_PUBLIC_KEY: ${{ secrets.DOCKER_PUBLIC_KEY }}

      - name: Verify the signed Docker image
        run: cosign verify --key public_key.pem docker.io/sidwar/myapp:latest
